var posToChar={/*0:0,*/1:57857,2:57858,3:57859,4:57860,5:57861,6:57862,7:57863,8:57864,9:9,10:9733,11:57867,12:57868,13:10,14:57870,15:57871,16:9834,17:57873,18:57874,19:57875,20:57876,21:57877,22:57878,23:57879,24:57880,25:57881,26:9678,27:57883,28:8594,29:8592,30:8593,31:8595,32:32,33:33,34:34,35:35,36:36,37:37,38:38,39:39,40:40,41:41,42:42,43:43,44:44,45:45,46:46,47:47,48:48,49:49,50:50,51:51,52:52,53:53,54:54,55:55,56:56,57:57,58:58,59:59,60:60,61:61,62:62,63:63,64:64,65:65,66:66,67:67,68:68,69:69,70:70,71:71,72:72,73:73,74:74,75:75,76:76,77:77,78:78,79:79,80:80,81:81,82:82,83:83,84:84,85:85,86:86,87:87,88:88,89:89,90:90,91:91,92:92,93:93,94:94,95:95,96:96,97:97,98:98,99:99,100:100,101:101,102:102,103:103,104:104,105:105,106:106,107:107,108:108,109:109,110:110,111:111,112:112,113:113,114:114,115:115,116:116,117:117,118:118,119:119,120:120,121:121,122:122,123:123,124:124,125:125,126:126,127:127,128:9671,129:57985,130:57986,131:57987,132:57988,133:57989,134:57990,135:57991,136:57992,137:57993,138:57994,139:57995,140:57996,141:57997,142:57998,143:57999,144:9524,145:9516,146:9500,147:9532,148:9508,149:9472,150:9474,151:58007,152:9484,153:9488,154:9492,155:9496,156:58012,157:58013,158:58014,159:58015,160:12316,161:12290,162:12300,163:12301,164:12289,165:12539,166:12530,167:12449,168:12451,169:12453,170:12455,171:12457,172:12515,173:12517,174:12519,175:12483,176:12540,177:12450,178:12452,179:12454,180:12456,181:12458,182:12459,183:12461,184:12463,185:12465,186:12467,187:12469,188:12471,189:12473,190:12475,191:12477,192:12479,193:12481,194:12484,195:12486,196:12488,197:12490,198:12491,199:12492,200:12493,201:12494,202:12495,203:12498,204:12501,205:12504,206:12507,207:12510,208:12511,209:12512,210:12513,211:12514,212:12516,213:12518,214:12520,215:12521,216:12522,217:12523,218:12524,219:12525,220:12527,221:12531,223:176,224:9632,225:9679,226:9650,227:9660,228:9633,229:9675,230:9651,231:9661,232:58088,233:58089,234:58090,235:58091,236:58092,237:58093,238:58094,239:58095,240:9824,241:9829,242:9670,243:9827,244:58100,245:58101,246:58102,247:58103,248:58104,249:58105,250:58106,251:58107,252:58108,253:58109,254:58110,255:58111,256:12460,257:12462,258:12464,259:12466,260:12468,261:12470,262:12472,263:12474,264:12476,265:12478,266:12480,267:12482,268:12485,269:12487,270:12489,271:12496,272:12499,273:12502,274:12505,275:12508,276:12497,277:12500,278:12503,279:12506,280:12509,281:12532,282:12533,283:12534,284:12526,285:12430,286:8730,287:8470,288:374,289:375,290:12302,291:12303,292:170,293:8230,294:12434,295:12353,296:12355,297:12357,298:12359,299:12361,300:12419,301:12421,302:12423,303:12387,304:175,305:12354,306:12356,307:12358,308:12360,309:12362,310:12363,311:12365,312:12367,313:12369,314:12371,315:12373,316:12375,317:12377,318:12379,319:12381,320:12383,321:12385,322:12388,323:12390,324:12392,325:12394,326:12395,327:12396,328:12397,329:12398,330:12399,331:12402,332:12405,333:12408,334:12411,335:12414,336:12415,337:12416,338:12417,339:12418,340:12420,341:12422,342:12424,343:12425,344:12426,345:12427,346:12428,347:12429,348:12431,349:12435,350:12443,351:12444,352:12364,353:12366,354:12368,355:12370,356:12372,357:12374,358:12376,359:12378,360:12380,361:12382,362:12384,363:12386,364:12389,365:12391,366:12393,367:12400,368:12403,369:12406,370:12409,371:12412,372:12401,373:12404,374:12407,375:12410,376:12413,377:164,378:161,379:186,380:185,381:178,382:179,383:172,384:215,385:247,386:177,387:8704,388:8706,389:8834,390:8835,391:8734,392:8756,393:8757,394:8978,395:8224,396:8225,397:167,398:182,399:65372,400:166,401:162,402:8364,403:163,404:8240,405:8658,406:8660,407:12306,408:9792,409:9794,410:8251,411:9837,412:169,413:174,414:8220,415:8221,416:12319,417:12317,418:12293,419:20189,420:12291,421:12445,422:12446,423:12294,425:168,426:900,428:180,429:8243,430:901,431:383,432:12304,433:12305,434:9734,435:12296,436:12297,437:12298,438:12299,439:57909,440:181,441:188,442:189,443:190,444:191,445:8482,446:8249,447:8250,448:352,449:381,450:256,451:258,452:260,453:262,454:266,455:268,456:270,457:274,458:276,459:278,460:280,461:286,462:288,463:290,464:294,465:298,466:302,467:304,469:306,470:310,471:313,472:315,473:317,474:321,475:323,476:325,477:327,478:336,479:340,480:344,481:346,482:350,483:356,484:362,485:366,486:368,487:370,488:377,489:379,490:402,491:453,492:498,493:354,494:264,495:284,496:1071,497:312,498:57910,499:902,500:904,501:905,502:906,503:908,504:910,505:911,506:938,507:939,508:912,509:944,510:962,511:894,512:353,513:382,514:257,515:259,516:261,517:263,518:267,519:269,520:271,521:275,522:277,523:279,524:281,525:287,526:289,527:291,528:295,529:299,530:303,532:305,533:307,534:311,535:314,536:316,537:318,538:322,539:324,540:326,541:328,542:337,543:341,544:345,545:347,546:351,547:357,548:363,549:367,550:369,551:371,552:378,553:380,554:329,555:454,556:499,557:355,558:265,559:285,560:1103,561:171,562:187,563:940,564:941,565:942,566:943,567:972,568:973,569:974,570:970,571:971,572:184,573:173,574:57911,575:254,576:192,577:193,578:194,579:195,580:196,581:197,582:198,583:199,584:200,585:201,586:202,587:203,588:204,589:205,590:206,591:207,592:208,593:209,594:210,595:211,596:212,597:213,598:214,599:216,600:338,601:217,602:218,603:219,604:220,605:221,606:376,607:222,608:224,609:225,610:226,611:227,612:228,613:229,614:230,615:231,616:232,617:233,618:234,619:235,620:236,621:237,622:238,623:239,624:240,625:241,626:242,627:243,628:244,629:245,630:246,631:248,632:339,633:249,634:250,635:251,636:252,637:253,638:255,639:223,640:913,641:914,642:915,643:916,644:917,645:918,646:919,647:920,648:921,649:922,650:923,651:924,652:925,653:926,654:927,655:928,656:929,657:931,658:932,659:933,660:934,661:935,662:936,663:937,664:183,665:711,666:728,667:729,668:731,669:732,671:57912,672:945,673:946,674:947,675:948,676:949,677:950,678:951,679:952,680:953,681:954,682:955,683:956,684:957,685:958,686:959,687:960,688:961,689:963,690:964,691:965,692:966,693:967,694:968,695:969,696:8361,697:8222,698:8217,699:8218,700:8219,701:9825,702:9831,704:1040,705:1041,706:1042,707:1043,708:1044,709:1045,710:1025,711:1046,712:1047,713:1048,714:1049,715:1050,716:1051,717:1052,718:1053,719:1054,720:1055,721:1056,722:1057,723:1058,724:1059,725:1060,726:1061,727:1062,728:1063,729:1064,730:1065,731:1066,732:1067,733:1068,734:1069,735:1070,736:1072,737:1073,738:1074,739:1075,740:1076,741:1077,742:1105,743:1078,744:1079,745:1080,746:1081,747:1082,748:1083,749:1084,750:1085,751:1086,752:1087,753:1088,754:1089,755:1090,756:1091,757:1092,758:1093,759:1094,760:1095,761:1096,762:1097,763:1098,764:1099,765:1100,766:1101,767:1102,768:730,769:57889,770:57890,771:57891,772:57892,773:57893,774:57894,775:57895,776:57896,777:57897,778:57898,779:57899,780:57900,781:57901,782:57902,783:57903,784:57904,785:57905,786:57906,787:57907,788:57908,789:9590,790:9591,791:9588,792:9589,793:9531,794:9523,795:9507,796:9547,797:9515,798:9473,799:9475,800:9487,801:9491,802:9495,803:9499,804:9594,805:9595,806:9592,807:9593,808:9527,809:9519,810:9528,811:9520,812:9504,813:9538,814:9512,815:9501,816:9535,817:9509,818:292,819:296,820:300,821:308,822:319,823:330,824:332,825:334,826:342,827:348,828:358,829:360,830:364,831:372,832:57920,833:57921,834:57922,835:57923,836:57924,837:57925,838:57926,839:57927,840:57928,841:57929,842:57930,843:9828,844:57932,845:57933,846:57934,847:57935,848:57936,849:57937,850:57938,851:57939,852:57940,853:57914,854:57915,855:57916,856:57917,857:57918,858:57919,859:57913,863:496,864:58016,865:58017,866:58018,867:58019,868:58020,869:58021,870:58022,871:58023,872:58024,873:58025,874:58026,875:58027,876:58028,877:58029,878:58030,879:58031,880:58032,881:58033,882:293,883:297,884:301,885:309,886:320,887:331,888:333,889:335,890:343,891:349,892:359,893:361,894:365,895:373,896:57600,897:57601,898:57602,899:57603,900:57604,901:57605,902:57606,903:57607,904:57608,905:57609,906:57610,907:57611,908:57612,909:57613,910:57614,911:57615,912:57616,913:57617,914:57618,915:57619,916:57620,917:57621,918:57622,919:57623,920:57624,921:57625,922:57626,923:57627,924:57628,925:57629,926:57630,927:57631,928:57632,929:57633,930:57634,931:57635,932:57636,933:57637,934:57638,935:57639,936:57640,937:57641,938:57642,939:57643,940:57644,941:57645,942:57646,943:57647,944:57648,945:57649,946:57650,947:57651,948:57652,949:57653,950:57654,951:57655,952:57656,953:57657,954:57658,955:57659,956:57660,957:57661,958:57662,959:57663,960:57664,961:57665,962:57666,963:57667,964:57668,965:57669,966:57670,967:57671,968:57672,969:57673,970:57674,971:57675,972:57676,973:57677,974:57678,975:57679,976:57680,977:57681,978:57682,979:57683,980:57684,981:57685,982:57686,983:57687,984:57688,985:57689,986:57690,987:57691,988:57692,989:57693,990:57694,991:57695,992:57696,993:57697,994:57698,995:57699,996:57700,997:57701,998:57702,999:57703,1000:57704,1001:57705,1002:57706,1003:57707,1004:57708,1005:57709,1006:57710,1007:57711,1008:57712,1009:57713,1010:57714,1011:57715,1012:57716,1013:57717,1014:57718,1015:57719,1016:57720,1017:57721,1018:57722,1019:57723,1020:57724,1021:57725,1022:57726,1023:57727};

var form = document.getElementsByTagName("form")[0];

var f2d;

form.imagedisplay = document.getElementById("imagedisplay");
form.imagehistogram = document.getElementById("imagehistogram");
form.imageoutput = document.getElementById("imageoutput");

form.imagefileinput.onchange = function () {
	var reader = new FileReader();
	textFile=false;
	reader.onload = function () {
		form.imagedisplay.onload = function () {
			if(form.imagedisplay.width!=400 || form.imagedisplay.height!=240){
				alert("wrong image size (expected 400x240)");
				form.imagedisplay.src="";
				return;
			}
			form.textinput.value=decode(form.imagedisplay,form.imagehistogram);
			form.convert2.click();
		};
		form.imagedisplay.src = reader.result;
	};
	reader.readAsDataURL(this.files[0]);
};

form.textfileinput.onchange = function (){
	var reader = new FileReader();	
	reader.onload = function () {
		form.textinput.value=reader.result;
		form.convert2.click();
	};
	reader.readAsText(this.files[0]);
}

function go(){
	var colors={
		"text":null,
		"number":null,
		"string":null,
		"label":null,
		"function":null,
		"keyword":null,
		"comment":null,
		"background":null
	}
	for(var i in colors)
		colors[i]=parseInt(form[i].value.substr(1),16);
	form.imageoutput.src=makeScreenshot(form.textinput.value,colors);
}

var s2d;

function decode(screenshot,graph){
	s2d.drawImage(screenshot,0,0);
	var data=s2d.getImageData(4*8,0,400-4*8,240-8).data;
	var table=brightnessTable(data);
	var threshold=widestGap(table,20);
	if(brightness(data[8*400*4],data[8*400*4+1],data[8*400*4+2])>threshold)
		var invert=true;
	histogram(graph,table,240);
	var g2d=graph.getContext("2d");
	g2d.fillStyle = "red";
	g2d.fillRect(threshold,0,1,255);
	
	var code="";
	(function(){
		for(var y=0;y<240-8;y+=8){
			for(var x=8*4;x<400;x+=8){
				var match=findMatch(s2d.getImageData(x,y,8,8).data,threshold,invert);

				if(match==-1){
					alert("Could not read character");
					return;
				}
				if(match==10){
					line="";
					x=400;
				}
				code+=String.fromCharCode(match);
			}
		}
	}());
	return code.match(/^[\s\S]*?(?= *$)/)[0];
}

function toBw(data,threshold,invert){
	var out=Array(data.length/4);
	for(var i=0;i<data.length;i+=4)
		out[i/4] = (brightness(data[i],data[i+1],data[i+2])>threshold)!=!!invert?1:0;
	return out;
}

function brightness(r,g,b){
	return r*0.299+g*0.587+b*0.114;
}

function compareTo(data,chr,threshold,invert){
	var bw=toBw(data,threshold,invert);
	for(var i=0;i<8*8;i++){
		if(bw[i]!=font[chr][i])
			return false;
	}
	return true;
}

function findMatch(data,threshold,invert){
	for(var i in font)
		if(compareTo(data,i,threshold,invert))
			return posToChar[i];
	return -1;
}

function histogram(graph,array,height){
	var g2d=graph.getContext("2d");
	graph.width=array.length;
	graph.height=height;
	var max=0
	for(var i=0;i<array.length;i++)
		if(array[i]>max)
			max=array[i];
	for(var i=0;i<array.length;i++)
		g2d.fillRect(i,height,1,-(Math.log(array[i]+1,2)*height/Math.log(max,2)));
}

function widestGap(table,start){
	var gapSize=0;
	var maxGapSize=0;
	var gap;
	var started;
	for(var i=start||0;i<table.length;i++){
		if(table[i]===0){
			gapSize++;
		}else{
			if(started && gapSize > maxGapSize){
				maxGapSize = gapSize;
				gap = i-gapSize/2;
			}
			gapSize=0;
			started=true;
		}
	}
	return gap;
}

function brightnessTable(data){
	var table=[];
	for(var i=0;i<256;i++)
		table[i]=0;
	for(var i=0;i<data.length;i+=4){
		table[Math.floor(brightness(data[i],data[i+1],data[i+2]))]++;
	}
	return table;
}

function brightnessMidRange(data){
	var min=Infinity,max=-Infinity;
	for(var i=0;i<data.length;i+=4){
		var bright=brightness(data[i],data[i+1],data[i+2]);
		if(bright<min)
			min=bright;
		if(bright>max)
			max=bright;
	}
	return (min+max)/2
}

var textFile;

var font=Array(16*64);
window.onload=function(){
	var fc=document.createElement("canvas");
	fc.height=fontimage.height;
	fc.width=fontimage.width;
	f2d=fc.getContext("2d");
	f2d.drawImage(fontimage,0,0);
	
	for(var i in posToChar)
		font[i]=toBw(f2d.getImageData(i%64*8,Math.floor(i/64)*8,8,8).data,127);
	
	s2d=sc.getContext("2d");
}